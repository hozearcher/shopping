<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å¯æ„›å°èˆ– âœ¨</title>
  <style>
    :root{
      --bg:#fff7fb; --card:#ffffff; --ink:#2b2b2b;
      --pink:#ff6fae; --pink2:#ffd1e6; --mint:#7ee0c3;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      font-family: ui-sans-serif, system-ui, "Noto Sans TC", Arial;
    }
    body{margin:0;background:radial-gradient(1200px 600px at 20% 0%, #ffe6f2, transparent),
                   radial-gradient(900px 600px at 90% 10%, #e8fff8, transparent),
                   var(--bg); color:var(--ink);}
    header{position:sticky;top:0;backdrop-filter: blur(10px);
      background:rgba(255,247,251,.7); border-bottom:1px solid rgba(0,0,0,.06); z-index:10;}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px;}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800}
    .logo{width:40px;height:40px;border-radius:14px;background:linear-gradient(135deg,var(--pink),var(--mint));
      box-shadow: var(--shadow);}
    .pill{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.8);
      border:1px solid rgba(0,0,0,.07); padding:10px 12px;border-radius:999px; box-shadow: 0 6px 16px rgba(0,0,0,.05);}
    input,select{border:none;outline:none;background:transparent;font-size:14px;}
    button{border:none;cursor:pointer;border-radius:999px;padding:10px 14px;font-weight:700;}
    .btn{background:linear-gradient(135deg,var(--pink),#ff9ed0); color:white; box-shadow: 0 10px 18px rgba(255,111,174,.25);}
    .btn2{background:rgba(0,0,0,.06);}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:18px;}
    @media(max-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:420px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.9); border:1px solid rgba(0,0,0,.06);
      border-radius:var(--radius); overflow:hidden; box-shadow: var(--shadow);}
    .img{aspect-ratio: 1/1; background:#f3f3f3; display:block; width:100%; object-fit:cover;}
    .pad{padding:12px;}
    .title{font-weight:800;margin:0 0 6px; line-height:1.2}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .price{font-weight:900;color:#ff3d97}
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,111,174,.12);border:1px dashed rgba(255,111,174,.35)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,.75);
      color:white;padding:10px 12px;border-radius:12px;display:none}
    .drawer{position:fixed;right:0;top:0;height:100%;width:min(420px,100%);background:rgba(255,255,255,.96);
      border-left:1px solid rgba(0,0,0,.08); box-shadow: -20px 0 60px rgba(0,0,0,.12); transform:translateX(110%);
      transition:.25s; z-index:20;}
    .drawer.open{transform:translateX(0)}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .cartItem{padding:12px;border-bottom:1px solid rgba(0,0,0,.06)}
    .qty{display:flex;gap:8px;align-items:center}
    .qty button{padding:6px 10px}
    .footer{opacity:.75; font-size:12px; padding:30px 0;}
  </style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="brand"><div class="logo"></div> å¯æ„›å°èˆ– <span style="font-weight:600;opacity:.7">âœ¨ marketplace</span></div>
    <div class="pill">
      <input id="q" placeholder="æœå°‹å¯æ„›å•†å“â€¦"/>
      <select id="cat">
        <option value="">å…¨éƒ¨åˆ†é¡</option>
        <option value="è²¼ç´™">è²¼ç´™</option>
        <option value="å°ç‰©">å°ç‰©</option>
        <option value="3C">3C</option>
      </select>
      <button class="btn2" onclick="loadProducts()">æœå°‹</button>
    </div>
    <button class="btn" onclick="toggleCart(true)">è³¼ç‰©è»Š ğŸ§º <span id="cartCount">0</span></button>
  </div>
</header>

<main class="wrap">
  <h2 style="margin:18px 0 6px;">ä»Šæ—¥ç²¾é¸ ğŸ’–</h2>
  <div style="opacity:.75">ç²‰å«©ä¸Šæ¶ä¸­ï½æŒ‘ä¸€å€‹å¸¶å›å®¶å§ï¼</div>
  <div id="grid" class="grid"></div>
  <div class="footer">Made with HTML + Apps Script + Sheets</div>
</main>

<!-- Cart Drawer -->
<div id="drawer" class="drawer">
  <div class="wrap">
    <div class="row" style="margin:10px 0;">
      <h3 style="margin:0;">ä½ çš„è³¼ç‰©è»Š ğŸ§</h3>
      <button class="btn2" onclick="toggleCart(false)">é—œé–‰</button>
    </div>
    <div id="cartList"></div>

    <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.06)">
      <div class="row"><div>å°è¨ˆ</div><div style="font-weight:900" id="sum">$0</div></div>

      <h4 style="margin:14px 0 8px;">çµå¸³è³‡è¨Š</h4>
      <div class="pill" style="border-radius:16px;flex-direction:column;align-items:stretch;gap:8px;">
        <input id="buyerName" placeholder="å§“å"/>
        <input id="buyerEmail" placeholder="Email"/>
        <input id="buyerPhone" placeholder="æ‰‹æ©Ÿ (é¸å¡«)"/>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;">
        <button class="btn" style="flex:1" onclick="checkout()">é€å‡ºè¨‚å–® ğŸ§¾</button>
        <button class="btn2" onclick="clearCart()">æ¸…ç©º</button>
      </div>

      <div style="margin-top:14px;opacity:.8;font-size:13px">
        è¨‚å–®æŸ¥è©¢ï¼šç”¨ã€Œè¨‚å–®è™Ÿ + Emailã€åˆ°å¾Œç«¯æŸ¥ï¼ˆå¯åŠ ä¸€å€‹æŸ¥è©¢é ï¼‰
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  const API_URL = "æŠŠä½ çš„Apps Script Web App URLè²¼é€™è£¡"; // ä¾‹å¦‚ https://script.google.com/macros/s/xxxxx/exec

  const LS_KEY = "cuteMallCart_v1";

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg; t.style.display="block";
    setTimeout(()=>t.style.display="none", 1600);
  }

  function getCart(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch(e){ return []; }
  }
  function setCart(items){
    localStorage.setItem(LS_KEY, JSON.stringify(items));
    renderCartBadge();
  }
  function addToCart(p){
    const cart = getCart();
    const found = cart.find(x=>x.productId===p.productId);
    if(found) found.qty += 1;
    else cart.push({productId:p.productId, title:p.title, price:p.price, qty:1});
    setCart(cart);
    toast("å·²åŠ å…¥è³¼ç‰©è»Š âœ¨");
  }
  function updateQty(pid, delta){
    const cart = getCart();
    const it = cart.find(x=>x.productId===pid);
    if(!it) return;
    it.qty += delta;
    if(it.qty<=0) cart.splice(cart.indexOf(it),1);
    setCart(cart);
    renderCart();
  }
  function clearCart(){ setCart([]); renderCart(); toast("å·²æ¸…ç©º"); }

  function renderCartBadge(){
    const cart = getCart();
    const count = cart.reduce((s,x)=>s+x.qty,0);
    document.getElementById("cartCount").textContent = count;
  }

  async function loadProducts(){
    const q = encodeURIComponent(document.getElementById("q").value.trim());
    const category = encodeURIComponent(document.getElementById("cat").value.trim());
    const url = `${API_URL}?action=listProducts&q=${q}&category=${category}`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.ok){ toast("è¼‰å…¥å¤±æ•—"); return; }
    renderGrid(data.data);
  }

  function renderGrid(items){
    const grid = document.getElementById("grid");
    grid.innerHTML = items.map(p => `
      <div class="card">
        <img class="img" src="${p.imageUrl || "https://picsum.photos/seed/"+p.productId+"/600"}" alt="">
        <div class="pad">
          <div class="meta">
            <div class="tag">${p.category || "æœªåˆ†é¡"}</div>
            <div style="font-size:12px;opacity:.è¯æ˜">åº«å­˜ ${p.stock}</div>
          </div>
          <h3 class="title">${escapeHtml(p.title)}</h3>
          <div class="row">
            <div class="price">$${p.price}</div>
            <button class="btn" onclick='addToCart(${JSON.stringify({productId:p.productId,title:p.title,price:p.price})})'>åŠ å…¥ ğŸ§º</button>
          </div>
          <div style="margin-top:8px;opacity:.7;font-size:13px;line-height:1.4">
            ${escapeHtml((p.desc||"").slice(0,60))}${(p.desc||"").length>60?"â€¦":""}
          </div>
        </div>
      </div>
    `).join("");
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function toggleCart(open){
    document.getElementById("drawer").classList.toggle("open", !!open);
    if(open) renderCart();
  }

  function renderCart(){
    const cart = getCart();
    const list = document.getElementById("cartList");
    if(cart.length===0){
      list.innerHTML = `<div style="padding:18px;opacity:.7">é‚„æ²’æœ‰é¸å•†å“ï½å»é€›é€›å§ ğŸ°</div>`;
      document.getElementById("sum").textContent = "$0";
      return;
    }
    list.innerHTML = cart.map(it=>`
      <div class="cartItem">
        <div class="row">
          <div style="font-weight:800">${escapeHtml(it.title)}</div>
          <div style="font-weight:900;color:#ff3d97">$${it.price}</div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="qty">
            <button class="btn2" onclick="updateQty('${it.productId}',-1)">-</button>
            <div style="min-width:24px;text-align:center;font-weight:800">${it.qty}</div>
            <button class="btn2" onclick="updateQty('${it.productId}',+1)">+</button>
          </div>
          <div style="opacity:.8">å°è¨ˆ $${it.qty * it.price}</div>
        </div>
      </div>
    `).join("");

    const sum = cart.reduce((s,x)=>s + x.qty*x.price,0);
    document.getElementById("sum").textContent = "$" + sum;
  }

  async function checkout(){
    const buyerName = document.getElementById("buyerName").value.trim();
    const buyerEmail = document.getElementById("buyerEmail").value.trim();
    const buyerPhone = document.getElementById("buyerPhone").value.trim();
    const items = getCart();

    if(!buyerName || !buyerEmail){ toast("è«‹å¡«å§“åèˆ‡Email"); return; }
    if(items.length===0){ toast("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }

    const payload = { action:"createOrder", buyerName, buyerEmail, buyerPhone, items };

    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!data.ok){ toast("ä¸‹å–®å¤±æ•—ï¼š" + (data.error||"")); return; }

    toast(`ä¸‹å–®æˆåŠŸï¼è¨‚å–®è™Ÿ ${data.data.orderId}`);
    clearCart();
  }

  renderCartBadge();
  loadProducts();
</script>
</body>
</html>
